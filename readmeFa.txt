
DataMapper یک ابزار مستقل دسکتاپ (مبتنی بر Python و کتابخانه Pandas) است که هدف اصلی آن، استانداردسازی و تثبیت مقادیر ناهمگون در یک ستون کلیدی (ستون اصلاح) در فایل‌های داده (Excel/CSV) است. این ابزار به طور هوشمند مقادیر خالی یا نامعتبر را شناسایی کرده و با استفاده از دو مکانیسم جستجوی داخلی و خارجی (نقشه تثبیت)، بهترین پیشنهادهای اصلاحی را به کاربر ارائه می‌دهد.

 ۱. مرحله آماده‌سازی و ورودی

1.  بارگذاری فایل: برنامه فایل اکسل یا CSV را بارگذاری می‌کند. بلافاصله، یک تابع کمکی اجرا می‌شود تا تمام حروف عربی (مانند "ي" و "ك") در کل دیتافریم به معادل فارسی ("ی" و "ک") تبدیل شوند. این کار اساس استانداردسازی است.
2.  انتخاب ستون اصلاح (Fix Column): کاربر ستونی را انتخاب می‌کند که قرار است مقادیر آن استاندارد شوند.
3.  تعریف خطا: کاربر مشخص می‌کند که چه ردیف‌هایی باید جستجو شوند:
    * ردیف‌هایی که ستون اصلاح در آن‌ها خالی (Null) است.
    * ردیف‌هایی که مقدار ستون اصلاح در آن‌ها جزو مقادیر نامعتبر انتخاب شده توسط کاربر است.
4.  تعیین ستون‌های جستجو (Search Columns): کاربر ستون‌هایی را انتخاب می‌کند که برنامه باید برای یافتن سرنخ و پیشنهاد اصلاحی، در آن‌ها جستجو کند.
5.  بارگذاری نقشه تثبیت (Consolidation Map): این مهم‌ترین ورودی خارجی است. کاربر یک فایل مرجع را بارگذاری می‌کند که شامل دو ستون است: ۱) مقدار استاندارد (Target) و ۲) ورودی‌های نامعتبر یا مستعار (Aliases) که باید به آن مقدار استاندارد نگاشت شوند.

 ۲. منطق اصلی جستجو و پیشنهاددهی (`find_rows`)

هسته اصلی برنامه تابع `find_rows` است که ردیف به ردیف دیتافریم را بررسی کرده و برای هر ردیف دارای خطا، بهترین پیشنهادها را پیدا و رتبه‌بندی می‌کند.

A. پیش‌پردازش داخلی (ساخت دیکشنری استاندارد):

قبل از شروع جستجو، برنامه تمام مقادیر یکتا و معتبر ستون اصلاح را استخراج کرده و نسخه‌ی نرمال‌شده (حذف فاصله‌های اضافی، نیم‌فاصله، علائم نگارشی و تبدیل به حروف کوچک) آن‌ها را در یک دیکشنری استاندارد ذخیره می‌کند. این دیکشنری، مرجع جستجوی داخلی خواهد بود.

B. فیلتر کردن ردیف‌های خطا:

برنامه بر اساس شرایط تعریف‌شده در مرحله ۱ (خالی بودن یا نامعتبر بودن)، ردیف‌های دارای خطا را فیلتر می‌کند.

C. رتبه‌بندی و تولید پیشنهاد (سیستم جستجوی چند لایه):

برای هر ردیف دارای خطا، برنامه پیشنهادات را در سه سطح (Priority) جستجو و جمع‌آوری می‌کند. هدف، یافتن معتبرترین مقدار از داده‌های همان ردیف در ستون‌های جستجو است.

| رتبه | منبع جستجو | منطق | کاربرد اصلی |
| :---: | :---: | :---: | :---: |
| P0 | نقشه تثبیت (مستقیم) | اگر مقدار *نرمال‌شده* ستون اصلاح دقیقاً با یکی از ورودی‌های نقشه تثبیت (Alias) تطابق داشته باشد. | جایگزینی سریع مقادیر اشتباه اما تکراری. |
| P1 | ستون‌های جستجو (Token) | جستجوی هر توکن (کلمه) موجود در ستون‌های جستجو (مانند "تهران" یا "دفتر") که دقیقاً با یکی از مقادیر *استاندارد* دیکشنری داخلی (ساخته‌شده از Fix Column) تطابق داشته باشد. | یافتن نام استان یا شهر از آدرس کامل. |
| P2 | ستون‌های جستجو (Regex Map) | جستجوی ستون‌های جستجو با استفاده از الگوهای Regex ساخته شده از ورودی‌های نقشه تثبیت (Alias) برای یافتن عبارت‌های پیچیده‌تر در متن. | یافتن عباراتی مانند "منطقه ۱۷" که نیاز به تطابق جزئی در متن دارند. |

D. مرتب‌سازی نهایی پیشنهادها:

پس از جمع‌آوری همه پیشنهادات، آن‌ها بر اساس رتبه (P0، سپس P1، سپس P2) و در صورت تساوی رتبه، بر اساس موقعیت مکانی (اولین تطابق در ستون‌های جستجو) مرتب می‌شوند. بهترین پیشنهاد به عنوان "انتخاب نهایی اولیه" تعیین و تمام پیشنهادات دیگر به صورت لیست ("پیشنهاد ۱ | پیشنهاد ۲ | ...") در ستون مربوطه نمایش داده می‌شوند.

 ۳. تعامل کاربر و خروجی

1.  جدول نتایج (Treeview):
    * تمام ردیف‌های دارای خطا به همراه نوع خطا، پیشنهادهای یافت شده و ستون‌های کمکی (Display Columns) نمایش داده می‌شوند.
    * ستون "انتخاب نهایی" (Final Selection) در ابتدا با بهترین پیشنهاد پر می‌شود.
2.  ابزارهای اصلاح سریع:
    * منوی کلیک راست: با کلیک راست بر روی ستون پیشنهادات، کاربر می‌تواند هر یک از پیشنهادات را به سرعت انتخاب کرده و آن را در ستون "انتخاب نهایی" قرار دهد.
    * ویرایش مستقیم: ستون "انتخاب نهایی" قابل ویرایش است تا کاربر بتواند مقادیر را به صورت دستی وارد کند.
3.  اعمال اصلاحات و ذخیره:
    * با زدن دکمه "اعمال اصلاح و ذخیره"، برنامه تنها مقادیر ستون "انتخاب نهایی" که توسط کاربر تأیید شده‌اند (یعنی خالی نیستند) را استخراج می‌کند.
    * برنامه این مقادیر جدید را در ردیف‌های مربوطه دیتافریم اصلی اعمال می‌کند و فایل اصلاح‌شده‌ی نهایی را با فرمت CSV یا Excel ذخیره می‌نماید.